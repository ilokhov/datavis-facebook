"use strict";var months=["January","February","March","April","May","June","July","August","September","October","November","December"],parseDate=d3.timeParse("%Y-%m"),formatDate=d3.timeFormat("%B %Y");d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.moveToBack=function(){return this.each(function(){var t=this.parentNode.firstChild;t&&this.parentNode.insertBefore(this,t)})},window.addEventListener("load",function(){var t={top:20,right:40,bottom:20,left:10},e=960-t.left-t.right,a=400-t.top-t.bottom,n=d3.select("#friends");document.getElementById("friends").style.width="960px";var s=n.append("svg").attr("width",e+t.left+t.right).attr("height",a+t.top+t.bottom).append("g").attr("transform","translate("+t.left+", "+t.top+")");d3.csv("data/friends.csv",function(t,o){if(t)throw t;o.forEach(function(t,e){for(var a in t)"month"===a?t.month=parseDate(t.month):t[a]=+t[a]});var r=d3.scaleTime().range([0,e]),i=d3.scaleLinear().range([a,0]);r.domain(d3.extent(o,function(t){return t.month})).clamp(!0),i.domain([0,d3.max(o,function(t){return t.num})]).nice();var l=d3.axisBottom(r),d=d3.axisRight(i).ticks(5).tickSizeInner(-e).tickSizeOuter(0);s.append("g").attr("class","axis x-axis").attr("transform","translate(0,"+a+")").call(l),s.append("g").attr("class","axis y-axis").attr("transform","translate("+e+",0)").call(d).append("text").attr("class","y-axis-label").attr("y",-10).attr("x",20).text("Total number of friends");var c=d3.line().x(function(t){return r(t.month)}).y(function(t){return i(t.num)}).curve(d3.curveCatmullRom);s.append("path").datum(o).attr("class","line").attr("d",c);var m=s.append("path").datum(o).attr("class","outline").attr("d",c),p=[{note:{title:"196 friends deleted",label:"July 2010",wrap:120,padding:10},data:{month:"2010-07",num:"249"},dy:69,dx:69,subject:{radius:25}}],u=d3.annotation().type(d3.annotationCalloutCircle).accessors({x:function(t){return r(parseDate(t.month))},y:function(t){return i(t.num)}}).annotations(p),f=s.append("g").attr("class","annotation-container").call(u),h=n.append("div").attr("class","tooltip");m.on("mousemove",function(t){f.style("opacity","0");var e=d3.mouse(this)[0],a=d3.mouse(this)[1],n=r.invert(e),s=formatDate(n),o=void 0;t.forEach(function(t,e){s===formatDate(t.month)&&(o=t.num)}),h.style("display","block").style("left",e+20+"px").style("top",a-50+"px").html(s+'<br><span class="bold">'+o+"</span> friends")}).on("mouseleave",function(){f.style("opacity","1"),h.style("display","none")})})}),window.addEventListener("load",function(){function t(t,r){function i(t){"messages-update"===t?(x.moveToFront(),x.classed("active",!0),g.classed("active",!1),v.classed("active",!0),y.classed("active",!1),E.moveToFront(),E.classed("disabled",!1),s.classed("mode-timeline",!1),s.classed("mode-messages",!0)):(g.moveToFront(),g.classed("active",!0),x.classed("active",!1),y.classed("active",!0),v.classed("active",!1),E.classed("disabled",!0),s.classed("mode-timeline",!0),s.classed("mode-messages",!1)),B.style("display","none"),w.style("display","none"),D.moveToFront(),D.style("display","none")}t.forEach(function(t,e){for(var a in t)"month"===a?t.month=parseDate(t.month):t[a]=+t[a]}),r.forEach(function(t,e){for(var a in t)"month"===a?t.month=parseDate(t.month):t[a]=+t[a]});var l=d3.scaleTime().range([0,a]).domain(d3.extent(t,function(t){return t.month})).clamp(!0),d=d3.scaleLinear().range([n,0]).domain([0,d3.max(t,function(t){return t.num})]).nice(),c=d3.scaleLinear().range([n,0]).domain([0,d3.max(r,function(t){return t.num})]).nice(),m=d3.area().x(function(t){return l(t.month)}).y0(n).y1(function(t){return d(t.num)}).curve(d3.curveMonotoneX),p=d3.area().x(function(t){return l(t.month)}).y0(n).y1(function(t){return c(t.num)}).curve(d3.curveMonotoneX),u=d3.axisBottom(l),f=d3.axisRight(d).ticks(5),h=d3.axisRight(c).ticks(5);o.append("g").attr("class","axis x-axis").attr("transform","translate(0,"+n+")").call(u);var y=o.append("g").attr("class","axis y-axis").attr("transform","translate("+a+",0)").call(f),v=o.append("g").attr("class","axis y-axis active").attr("transform","translate("+a+",0)").call(h),g=o.append("path").datum(t).attr("class","area area-timeline").attr("d",m),x=o.append("path").datum(r).attr("class","area area-messages active").attr("d",p),b=[{note:{title:"My move to Berlin",label:"September 2011",wrap:120,padding:10},data:{month:"2011-09",num:"2697"},dy:-100,dx:-100,subject:{radius:25}},{type:d3.annotationCallout,note:{title:"Facebook launches Messenger app",label:"August 2011",wrap:120,padding:10},data:{month:"2011-08",num:"538"},dy:-120,dx:-120},{type:d3.annotationCallout,note:{title:"Facebook removes message function from Facebook app",label:"April 2014",wrap:130,padding:10},data:{month:"2014-04",num:"629"},dy:-250,dx:-60,subject:{radius:25}}],k=d3.annotation().type(d3.annotationCalloutCircle).accessors({x:function(t){return l(parseDate(t.month))},y:function(t){return c(t.num)}}).annotations(b),E=o.append("g").attr("class","annotation-container").call(k),w=o.insert("line",":first-child").attr("class","indicator-bg").attr("y1",20-e.top).attr("y2",n);d3.selectAll(".area").each(function(t,e){var a=String(e),s="compare-path-"+a,r=this.getAttribute("d");o.insert("defs",":first-child").append("clipPath").attr("id",s).append("path").attr("d",r),o.append("line").attr("class",function(){return"indicator indicator-"+a}).attr("y1","0").attr("y2",n).attr("clip-path","url(#"+s+")")});var D=d3.selectAll(".indicator"),B=s.append("div").attr("class","chart-info").html('<div id="compare-chart-info-date" class="chart-info-date"></div>\n                             <div id="compare-chart-info-inner"></div>'),A=document.getElementById("compare-chart-info-date"),C=document.getElementById("compare-chart-info-inner");s.classed("mode-messages",!0),s.selectAll(".button-update").on("click",function(){s.selectAll(".button-update").classed("button-update--active",!1),d3.select(this).classed("button-update--active",!0),i(this.id)}),s.on("mousemove",function(){E.style("opacity","0");var n=d3.mouse(this)[0];if(n>e.left&&n<a+e.left){var o=""+(String(n)-e.left);w.attr("x1",o).attr("x2",o).style("display","block"),D.attr("x1",o).attr("x2",o).style("display","block");var i=l.invert(n-e.left+5),d=formatDate(i),c=void 0;if(s.node().classList.contains("mode-messages")){var m=void 0;r.forEach(function(t,e){d===formatDate(t.month)&&(m=t.num)}),c='Messages: <span class="bold">'+m+"</span>"}else{var p=void 0;t.forEach(function(t,e){d===formatDate(t.month)&&(p=t.num)}),c='Timeline posts: <span class="bold">'+p+"</span>"}B.style("display","block"),A.textContent=d,C.innerHTML=c}else w.style("display","none"),D.style("display","none"),B.style("display","none")}).on("mouseleave",function(){E.style("opacity","1"),w.style("display","none"),D.style("display","none"),B.style("display","none")})}var e={top:150,right:40,bottom:20,left:10},a=1180-e.left-e.right,n=550-e.top-e.bottom,s=d3.select("#compare"),o=s.append("svg").attr("width",a+e.left+e.right).attr("height",n+e.top+e.bottom).append("g").attr("transform","translate("+e.left+", "+e.top+")");d3.queue().defer(d3.csv,"data/compare_timeline.csv").defer(d3.csv,"data/compare_messages.csv").await(function(e,a,n){if(e)throw e;t(a,n)})}),window.addEventListener("load",function(){var t={top:20,right:40,bottom:20,left:10},e=1180-t.left-t.right,a=500-t.top-t.bottom,n=d3.select("#messages"),s=n.append("svg").attr("width",e+t.left+t.right).attr("height",a+t.top+t.bottom).append("g").attr("transform","translate("+t.left+", "+t.top+")");d3.csv("data/messages.csv",function(o,r){if(o)throw o;var i=[];r.forEach(function(t,e){var a=0;for(var n in t)"month"===n?t.month=parseDate(t.month):(t[n]=+t[n],a+=t[n],0===e&&i.push(n));t.total=a});var l={},d=[];i.forEach(function(t){var e=d3.sum(r,function(e){return e[t]});l[t]=e,d.push(e)});var c=d3.stack().keys(i).order(d3.stackOrderAscending).offset(d3.stackOffsetNone),m=c(r),p=d3.scaleTime().range([0,e]),u=d3.scaleLinear().range([a,0]),f=["#65def1","#32936f","#1c4c5e","#75ed85","#0085ff"],h=d3.scaleOrdinal(f);p.domain(d3.extent(r,function(t){return t.month})).clamp(!0),u.domain([0,d3.max(m,function(t){return d3.max(t,function(t){return t[1]})})]);var y=d3.area().x(function(t){return p(t.data.month)}).y0(function(t){return u(t[0])}).y1(function(t){return u(t[1])}).curve(d3.curveMonotoneX),v=d3.axisBottom(p),g=d3.axisRight(u).ticks(5);s.append("g").attr("class","axis x-axis").attr("transform","translate(0,"+a+")").call(v),s.append("g").attr("class","axis y-axis").attr("transform","translate("+e+",0)").call(g);var x=s.selectAll(".layer").data(m).enter().append("g").attr("class","layer"),b=x.append("path").attr("class","path-area").attr("fill",function(t){return h(t.key)}).attr("d",y),k=s.insert("line",":first-child").attr("class","indicator-bg").attr("y1","0").attr("y2",a);x.each(function(t,e){var n="messages-path-"+String(e),s=this.getElementsByTagName("path")[0].getAttribute("d");d3.select(this).insert("defs",":first-child").append("clipPath").attr("id",n).append("path").attr("d",s),d3.select(this).append("line").attr("class","indicator").attr("y1","0").attr("y2",a).attr("clip-path","url(#"+n+")")});var E=d3.selectAll(".indicator");n.append("div").attr("class","y-axis-label").html("Number of messages");var w=n.append("div").attr("class","chart-info").html('<div id="messages-chart-info-date" class="chart-info-date"></div>\n                             <div>Messages total: <span id="messages-total" class="bold"></span></div>\n                             <div id="messages-thread-container">\n                               In this thread: <span id="messages-thread" class="bold"></span> <span id="messages-thread-colour">&#9679;</span>\n                             </div>'),D=document.getElementById("messages-chart-info-date"),B=document.getElementById("messages-total"),A=document.getElementById("messages-thread-container"),C=document.getElementById("messages-thread"),T=document.getElementById("messages-thread-colour");n.append("div").attr("class","blocker").style("width",e+"px").style("height","1px").style("bottom",t.bottom-1+"px").style("left",t.left+"px"),n.on("mousemove",function(){var a=d3.mouse(this)[0];if(a>t.left&&a<e+t.left){var n=""+(String(a)-t.left);k.attr("x1",n).attr("x2",n).style("display","block"),E.attr("x1",n).attr("x2",n).style("display","block");var s=p.invert(a-t.left+5),o=formatDate(s),i=void 0;r.forEach(function(t,e){o===formatDate(t.month)&&(i=t.total)}),w.style("display","block"),D.textContent=o,B.textContent=i}else k.style("display","none"),E.style("display","none"),w.style("display","none")}).on("mouseleave",function(){k.style("display","none"),E.style("display","none"),w.style("display","none")}),x.on("mouseover",function(t,e){b.style("opacity",function(t,a){return a===e?1:.35}),b.style("stroke-width",function(t,a){return a===e?1:0})}).on("mousemove",function(t,e){var a=d3.select(this).select(".path-area").attr("fill"),n=d3.mouse(this)[0],s=p.invert(n+5),o=formatDate(s),r=void 0;t.forEach(function(t,e){o===formatDate(t.data.month)&&(r=t[1]-t[0])}),A.style.display="block",C.textContent=r,T.style.color=a}).on("mouseleave",function(){b.style("opacity",null),b.style("stroke-width",null),A.style.display="none"})})});